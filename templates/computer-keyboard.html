<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>HTML5 Piano!</title>
<!--[if IE]>
<script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
<!--[if lt IE 9]>
<script src="http://ie7-js.googlecode.com/svn/version/2.1(beta3)/IE9.js"></script><![endif]-->

<script src="{{ url_for('static', filename='HTML5piano-master/html5piano.js') }}"></script>
<script>
window.addEventListener('load', function() {
    window.noteStarts = [];
    window.noteStops = [];
    Piano.load("piano", {
        width: 550,
        height: 550,
        backgroundFill: "#333",
        onKeyPress: function(note){
            console.log(note + " pressed");
            window.noteStarts.push([note, Date.now()]);
        },
        onKeyRelease: function(note){
            console.log(note + " released");
            window.noteStops.push([note, Date.now()])
        }
    });
});

function closestMultiple(n, b) {
    var closest = 1;
    var current = 1;
    while (current * (b-1) < n) {
        if (Math.abs(current * b - n) < Math.abs(closest * b - n)) {
            closest = current;
        }
        current += 1;
    }
    return closest;
}

function dumpData() {
    var TEMPO = 140; // IT'S FUCKING ARBITRARY OKAY

    var midi_notes = [];
    var ms_per_eighth = 60000 / TEMPO / 2;
    
    // Assuming they're the same length for now...
    console.log(window.noteStarts.length, window.noteStops.length);

    var beat = 0;
    for (var i=0; i < window.noteStarts.length; i++) {
        var delta;
        var duration;
        if (i < window.noteStarts.length - 1) {
            delta = window.noteStarts[i+1][1] - window.noteStarts[i][1];
            duration = closestMultiple(delta, ms_per_eighth);
        } else {
            duration = midi_notes[midi_notes.length-1][2];
        }
        midi_notes.push([
            window.noteStarts[i][0], // The note
            beat,
            duration
        ]);
        beat += duration;
    }
    console.log(JSON.stringify(midi_notes));
}

function clearData() {
    window.noteStarts = [];
    window.noteStops = [];
}

</script>
</head>

<body>
<button onClick="dumpData()">Dump data</button>
<button onClick="clearData()">Clear data</button>
<div id="piano"></div>

</body>

</html>
