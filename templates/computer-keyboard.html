<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>HTML5 Piano!</title>
<!--[if IE]>
<script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
<!--[if lt IE 9]>
<script src="http://ie7-js.googlecode.com/svn/version/2.1(beta3)/IE9.js"></script><![endif]-->

<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>

<script src="{{ url_for('static', filename='HTML5piano-master/html5piano.js') }}"></script>
<script>
window.addEventListener('load', function() {
    // Dirty dirty globals...
    window.noteMap = {
        "gs": 68,
        "a": 69,
        "bb": 70,
        "b": 71,
        "c": 72,
        "cs": 72,
        "d": 73,
        "eb": 74,
        "e": 75,
        "f": 76,
        "fs": 77,
        "g": 78
    };

    window.noteStarts = [];
    window.noteStops = [];

    Piano.load("piano", {
        width: 550,
        height: 550,
        backgroundFill: "#333",
        onKeyPress: function(note){
            console.log(note + " pressed");
            window.noteStarts.push([window.noteMap[note], Date.now()]);
        },
        onKeyRelease: function(note){
            console.log(note + " released");
            window.noteStops.push([window.noteMap[note], Date.now()])
        }
    });
});

function closestMultiple(n, b) {
    var closest = 1;
    var current = 1;
    while (current * (b-1) < n) {
        if (Math.abs(current * b - n) < Math.abs(closest * b - n)) {
            closest = current;
        }
        current += 1;
    }
    return closest;
}

function convertBeat(b) {
    // If the Shu fits... :)
    return String(Math.floor(b / 4)) + "." + String(b % 4 + 1);
}

function SendData(bpm, pitchList, timeList, durationList){
    if (pitchList.length == 0){
        return;
    }
    d = {
        bpm: bpm,
        pitches: pitchList,
        times: timeList,
        durations: durationList
    }
    jQuery.ajax({
        type: "POST",
        url: "http://" + window.location.host + "/songs",
        contentType: 'application/json',
        data: JSON.stringify(d),
        dataType: "json",
        success: function(response){
            console.log("HERP DERP");
            console.log(JSON.stringify(response));
            alert(JSON.stringify(response));
        }
    });
}

function dumpData() {
    var tempo = Number(document.getElementById('tempo').value);
    console.log(tempo);

    var midi_pitches = [];
    var midi_times = [];
    var midi_durations = [];

    var ms_per_eighth = 60000 / tempo / 2;
    
    // Assuming they're the same length for now...
    console.log(window.noteStarts.length, window.noteStops.length);

    var beat = 0;
    for (var i=0; i < window.noteStarts.length; i++) {
        var delta;
        var duration;
        if (window.noteStarts.length === 1) {
            duration = 1;
        } else if (i < window.noteStarts.length - 1) {
            delta = window.noteStarts[i+1][1] - window.noteStarts[i][1];
            duration = closestMultiple(delta, ms_per_eighth);
        } else {
            duration = midi_times[midi_times.length-1];
        }

        midi_pitches.push(window.noteStarts[i][0]);
        midi_times.push(convertBeat(beat));
        midi_durations.push(duration);

        beat += duration;
    }
    console.log(JSON.stringify(midi_pitches));
    console.log(JSON.stringify(midi_times));
    console.log(JSON.stringify(midi_durations));

    SendData(tempo, midi_pitches, midi_times, midi_durations);
}

function clearData() {
    window.noteStarts = [];
    window.noteStops = [];
}

</script>
</head>

<body>
<input id="tempo" value=140></input>
<button onClick="dumpData()">Generate Chords</button>
<button onClick="clearData()">Reset</button>
<div id="piano"></div>

</body>

</html>
